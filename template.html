<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="utf-8">
    <title>OSMontrouge</title>
    <link rel="stylesheet" href="https://unpkg.com/normalize.css@8.0.1/normalize.css"
          crossorigin=""/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.4.0/dist/leaflet.css"
          integrity="sha512-puBpdR0798OZvTTbP4A8Ix/l+A4dHDD0DGqYW6RQ+9jxkRFclaxxQb/SJAWZfWAkuyeQUytO7+7N4QKrDh+drA=="
          crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.4.0/dist/leaflet.js"
            integrity="sha512-QVftwZFqvtRNi0ZyCtsznlKSWOStnDORoefr1enyq5mVL4tmKB3S/EnC3rRJcxCPavG10IcrVGSmPh6Qw5lwrg=="
            crossorigin=""></script>

    <style>
      body { margin: 0; }
      h1 { margin: 1rem 0; font-size: 1.5rem;  }
      #map { height: 100vh; margin-left: 250px; }
      .sidebar {
        position: absolute;
        padding: 5px;
        width: 250px;
        max-width: 250px;
        min-width: 250px;
        height: 100vh;
      }
    </style>
  </head>
  <body>
    <div class="sidebar">
      <h1>OSMontrouge</h1>

      <% filters.forEach(({ id, name }) => { %>
        <label><input type="checkbox" data-name="<%= id %>" /> <%= name %></label>
        <br>
      <% }) %>
    </div>
    <div id="map"></div>

    <script>
      const map = L.map('map').setView([48.8144000, 2.3160600], 15);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
      }).addTo(map);

      function onEachFeature(feature, layer) {
          if (feature.properties && feature.properties.name) {
              layer.bindPopup(feature.properties.name);
          }
      }

      function pointToLayer(feature, latlng) {
          if (feature.properties.icon) {
              const icon = L.icon({
                  iconUrl: `icons/${feature.properties.icon}`,
                  iconSize: [32, 32]
              });
              return L.marker(latlng, { icon });
          } else {
              return L.marker(latlng);
          }
      }

      document.querySelectorAll('input[type=checkbox]').forEach((checkbox) => {
          let layer = null;
          const name = checkbox.dataset.name;
          checkbox.addEventListener('change', (e) => {
              if (e.target.checked) {
                  fetch(`/data/${name}.geojson`)
                      .then((response) => response.json())
                      .then((geojson) => {
                          layer = L.geoJSON(geojson, {onEachFeature, pointToLayer}).addTo(map);
                      });
              } else {
                  if (layer) {
                      layer.remove();
                      layer = null;
                  }
              }
          });
      });
    </script>
  </body>
</html>
